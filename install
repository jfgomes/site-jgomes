# Instala as extensÃµes PHP via PECL e habilita-as
RUN pecl install apcu \
    && docker-php-ext-enable apcu \
    && pecl install redis \
    && docker-php-ext-enable redis


apt-get update && apt-get install -y     apt-transport-https     ca-certificates     curl     gnupg     lsb-release    software-properties-common
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg     && echo "deb [signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null     && apt-get update && apt-get install -y docker-ce docker-ce-cli containerd.io
curl -fsSL https://github.com/docker/compose/releases/latest/download/docker-compose-Linux-x86_64 -o /usr/local/bin/docker-compose     && chmod +x /usr/local/bin/docker-compose
apt-get install apache2
npm install
apt install npm
apt-get install php-curl
apt-get install composer
apt-get install ext-dom
apt-get install php-xml
pecl install xdebug
apt install php-pear
apt-get install php-dev
pecl install xdebug
sudo apt-get install php-mysql
pecl install redis
cd ~/.ssh/
cp /tmp/installation-tmp/ssh/id_rsa .
cp /tmp/installation-tmp/ssh/id_rsa.pub .

cd /var/www/html/certs
cp /tmp/installation-tmp/certs/* .
chmod 600 *

cd /etc/apache5/sites-available
cp /tmp/installation-tmp/vhosts/* .

a2dissite default-ssl.conf && rm default-ssl.conf -f
a2dissite 000-default.conf && rm 000-default.conf -f

a2enmod proxy &&
a2enmod proxy_http &&
a2enmod mod_headers &&
a2enmod headers &&
a2enmod ssl

a2ensite vhost-80-443.conf
a2ensite vhost-app-ssl.conf
a2ensite vhost-jenkins.conf

service apache2 restart

cd /var/www/html/
git clone git@github.com:jfgomes/site-jgomes-prod-infra.git

cd site-jgomes-prod-infra/
git clone git@github.com:jfgomes/site-jgomes.git

docker-compose down
docker-compose up --build

cd site-jgomes/
cp /tmp/installation-tmp/.env .

composer update
npm run production
php artisan migrate

cd ../
cd storage/
chmod 777 -Rf framework/cache/
chmod 777 -Rf framework/sessions/

cd ../
cd public/
rm coverage-report -f
ln -s ../storage/coverage-report/ coverage-repor

cd ../
echo "xdebug.mode=coverage" | sudo tee -a $(php --ini | grep "Loaded Configuration" | sed -e "s|.*:\s*||")
echo "zend_extension=xdebug.so" | sudo tee -a $(php --ini | grep "Loaded Configuration" | sed -e "s|.*:\s*||")

service apache2 restart

vendor/bin/phpunit --coverage-html storage/coverage-report
sed -i "s|<head>|<head><title>Coverage</title>|" "storage/coverage-report/index.html" && sed -i "s|<head>|<head><title>Dashboard</title>|" "storage/coverage-report/dashboard.html" && find "storage/coverage-report" -type f -exec sed -i "s#/var/www/html/site-jgomes-prod-infra/site-jgomes/app#(Coverage)#g" {} +

falte a chave da vps para o git

falta nno host

/etc/hosts

127.0.0.1 rabbitmq
127.0.0.1 mysql
