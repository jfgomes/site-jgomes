apt-get update

ssh-keygen
cat /root/.ssh/id_rsa.pub
# copy the pub key to git

add the certs

apt install php-pear
apt-get install php-dev
pecl install apcu

apt-get update && apt-get install -y     apt-transport-https     ca-certificates     curl     gnupg     lsb-release    software-properties-common
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg     && echo "deb [signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null     && apt-get update && apt-get install -y docker-ce docker-ce-cli containerd.io
curl -fsSL https://github.com/docker/compose/releases/latest/download/docker-compose-Linux-x86_64 -o /usr/local/bin/docker-compose     && chmod +x /usr/local/bin/docker-compose


pecl install redis
apt install npm
apt-get install composer
apt-get install php-dom

apt-get install php-xml
sudo apt-get install php-curl # Adicionar a text ao php.ini

pecl install xdebug ( You should add "zend_extension=/usr/lib/php/20210902/xdebug.so" to php.ini )

sudo apt-get install php-mysql

# sudo lsof -i :80
# apt-get install apache2
sudo killall httpd

cd /var/www/html/
git clone git@github.com:jfgomes/site-jgomes-prod-infra.git

cd /etc/apache2/sites-available
cp /var/www/html/site-jgomes-prod-infra/scripts/vhosts/* .

a2dissite 000-default.conf
a2dissite default-ssl.conf

a2enmod proxy &&
a2enmod proxy_http &&
a2enmod headers &&
a2enmod ssl

systemctl restart apache2

a2ensite vhost-80-443.conf
a2ensite vhost-app.conf
a2ensite vhost-jenkins.conf

systemctl restart apache2


cd site-jgomes-prod-infra/
git clone git@github.com:jfgomes/site-jgomes.git

sudo service docker restart
sudo /etc/init.d/docker restart

docker-compose up --build -d

cd site-jgomes/

# Add .env vars ( UPDATE SCRIPT )

composer update

npm install laravel-mix --save-dev
npm run production
APP_ENV=prod php artisan migrate

#Ensure:
#zend_extension=/usr/lib/php/20210902/xdebug.so
#extension=curl.so
#[xdebug]
#xdebug.mode = coverage


vendor/bin/phpunit --coverage-html storage/coverage-report
cd storage

sed -i "s|<head>|<head><title>Coverage</title>|" "storage/coverage-report/index.html" && sed -i "s|<head>|<head><title>Dashboard</title>|" "storage/coverage-report/dashboard.html" && find "storage/coverage-report" -type f -exec sed -i "s#/var/www/html/site-jgomes-prod-infra/site-jgomes/app#(Coverage)#g" {} +

cd ../public/
rm coverage-report -f
ln -s ../storage/coverage-report/ coverage-repor

sed -i "s|<head>|<head><title>Coverage</title>|" "storage/coverage-report/index.html" && sed -i "s|<head>|<head><title>Dashboard</title>|" "storage/coverage-report/dashboard.html" && find "storage/coverage-report" -type f -exec sed -i "s#/var/www/html/site-jgomes-prod-infra/site-jgomes/app#(Coverage)#g" {} +
